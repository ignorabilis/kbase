(ns kbase.services.mail.parsing
  (:require [clojure.string :as string])
  (:import (java.net URISyntaxException URL)))

(def sample-body "https://www.nytimes.com/2018/10/08/us/fema-disaster-recovery-climate-change.html?action=click&module=Top%20Stories&pgtype=Homepage tag1 tag2\r\n\r\nhttps://www.nytimes.com/2018/10/08/us/fema-disaster-recovery-climate-change.html?action=click&module=Top%20Stories&pgtype=Homepage\r\nshould err\r\n\r\nIrina Yaroslavova Stefanova\r\nIgnorabilis Op. Ltd.\r\n\r\n+359886669686\r\nirina.yaroslavova@ignorabilis.com\r\n\r\n")
(def sample-mail '{:cc           (), :bcc (),
                   :headers      [{"Delivered-To" "owsy.test@gmail.com"} {"Received" "by 2002:a9d:b8b:0:0:0:0:0 with SMTP id 11csp1282503oth; Mon, 8 Oct\r\n 2018 04:16:12 -0700 (PDT)"} {"X-Google-Smtp-Source" "ACcGV62bbmRtJgKDgX4FKMucOdVVfMhq5anwO0J0rxNqo/Oq+LygqnEx2iG6ZnRug3cPbQWoBqNz"} {"X-Received" "by 2002:a1c:af07:: with SMTP id\r\n y7-v6mr15549098wme.33.1538997372342; Mon, 08 Oct 2018 04:16:12 -0700 (PDT)"} {"ARC-Seal" "i=1; a=rsa-sha256; t=1538997372; cv=none; d=google.com;\r\n s=arc-20160816;\r\n b=iSylqKvxr1NBzk/VoEXw5NqWIy4PDtPcaYonpCKdN+8uby4rsHB4FxkL9FxbF/ALNe\r\n XA5+3JEQDWxjAHyeNkz9VjiSXRASzvYAMrym/ypP/9NlvuRHdv7kxTVdbL9kkrSgLJxq\r\n UHhN/BJglr2QBfwy+4IFLpsHoT3mqEGy8dVwa8XQispNVXPhAjxTabP9STWvsl7y3AlV\r\n nrTGNjfS0wEZSFKyWydxkfBi44elcGqQvsahkYpxQZI3oinP120NILOCKFAjO401jYM/\r\n JydMfmW5motHhhqe8Tl2Z5UBY+lZ1BLEHoG1HUNorrwdRkNvnqPsoo1QyC0HTlc6VEvP ePCQ=="} {"ARC-Message-Signature" "i=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com;\r\n s=arc-20160816; h=mime-version:spamdiagnosticmetadata:spamdiagnosticoutput\r\n :content-language:accept-language:message-id:date:thread-index\r\n :thread-topic:subject:to:from:dkim-signature;\r\n bh=HfiSfW+IDGHjyQ4KLSaTP9E1xs9r4+LEF/mfNQnXDIs=;\r\n b=z2utW4CGQabxVD98SLb8bNTbuHf/XJBQfkj0asc8VR6Tt5bReg6ihCf0wuSHTYJTvG\r\n DMhRACAosZ6dgMILj8L5JbSO6AHPRMqJp1hr8yy6jNs4EC0fNalJaC4zyDWZqwVD4eO1\r\n j+cCsG24ibGoF7Rdv5zLqyu4awO18rZRuf+eeq23XxNTM/1tl6vSL2OBOj7qqyQeJPUc\r\n 7NNSGeyT8oOavN39xrIBj0TMgvLUXQkXN2QfNSEs5IqO+qGUvcUa04PxpKbFEnoAkhiv\r\n p2piCEZ1dOm1oCD/exbY1KyDufa97UHBEHejW6ZglqH8+/wjlvOkoOwV0KMm6TL9lgjy Gi6w=="} {"ARC-Authentication-Results" "i=1; mx.google.com; dkim=pass\r\n header.i=@svarogg.onmicrosoft.com header.s=selector1-ignorabilis-com\r\n header.b=nqMFDZ1d; spf=pass (google.com: domain of\r\n irina.yaroslavova@ignorabilis.com designates 40.107.6.136 as permitted sender)\r\n smtp.mailfrom=irina.yaroslavova@ignorabilis.com"} {"Return-Path" "<irina.yaroslavova@ignorabilis.com>"} {"Received" "from EUR04-DB3-obe.outbound.protection.outlook.com\r\n (mail-eopbgr60136.outbound.protection.outlook.com. [40.107.6.136]) by\r\n mx.google.com with ESMTPS id l18-v6si12082777wrr.138.2018.10.08.04.16.12 for\r\n <owsy.test@gmail.com> (version=TLS1_2 cipher=ECDHE-RSA-AES128-SHA\r\n bits=128/128); Mon, 08 Oct 2018 04:16:12 -0700 (PDT)"} {"Received-SPF" "pass (google.com: domain of irina.yaroslavova@ignorabilis.com\r\n designates 40.107.6.136 as permitted sender) client-ip=40.107.6.136;"} {"Authentication-Results" "mx.google.com; dkim=pass\r\n header.i=@svarogg.onmicrosoft.com header.s=selector1-ignorabilis-com\r\n header.b=nqMFDZ1d; spf=pass (google.com: domain of\r\n irina.yaroslavova@ignorabilis.com designates 40.107.6.136 as permitted sender)\r\n smtp.mailfrom=irina.yaroslavova@ignorabilis.com"} {"DKIM-Signature" "v=1; a=rsa-sha256; c=relaxed/relaxed;\r\n d=svarogg.onmicrosoft.com; s=selector1-ignorabilis-com;\r\n h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;\r\n bh=HfiSfW+IDGHjyQ4KLSaTP9E1xs9r4+LEF/mfNQnXDIs=;\r\n b=nqMFDZ1dnbkscjKZAQ+RWUxg9kWZaG8kcrjGB6G6lSwL5EDNdLwBbvChBUfOs9g4rhuzhmRAmhxrMYgC6Ff+UcgBOzQGVEyfYrbFC3Y+XndKRvqPhnr8AAQIUu89bx9IK8lNU7SAO4x94D7xnijX6jNhMQM4mhU7DJGFvZF2DcY="} {"Received" "from AM6PR10MB2328.EURPRD10.PROD.OUTLOOK.COM (20.177.116.21) by\r\n AM6PR10MB2424.EURPRD10.PROD.OUTLOOK.COM (20.177.116.85) with Microsoft SMTP\r\n Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id\r\n 15.20.1207.28; Mon, 8 Oct 2018 11:16:10 +0000"} {"Received" "from AM6PR10MB2328.EURPRD10.PROD.OUTLOOK.COM\r\n ([fe80::88c8:9bf0:b8dd:efba]) by AM6PR10MB2328.EURPRD10.PROD.OUTLOOK.COM\r\n ([fe80::88c8:9bf0:b8dd:efba%4]) with mapi id 15.20.1207.024; Mon, 8 Oct 2018\r\n 11:16:10 +0000"} {"From" "Irina Stefanova <irina.yaroslavova@ignorabilis.com>"} {"To" "\"owsy.test@gmail.com\" <owsy.test@gmail.com>"} {"Subject" "test"} {"Thread-Topic" "test"} {"Thread-Index" "AdRe+E/na54yEVO6TPm6EwlKoIrGrw=="} {"Date" "Mon, 8 Oct 2018 11:16:10 +0000"} {"Message-ID" "<AM6PR10MB2328F1401FAC7F1FA9834E95FEE60@AM6PR10MB2328.EURPRD10.PROD.OUTLOOK.COM>"} {"Accept-Language" "en-US"} {"Content-Language" "en-US"} {"X-MS-Has-Attach" ""} {"X-MS-TNEF-Correlator" ""} {"authentication-results" "spf=none (sender IP is )\r\n smtp.mailfrom=irina.yaroslavova@ignorabilis.com;"} {"x-originating-ip" "[84.242.153.7]"} {"x-ms-publictraffictype" "Email"} {"x-microsoft-exchange-diagnostics" "1;AM6PR10MB2424;6:5O0fDwXa8uxZ/6IJnKHaz80owDaq0wiV7Scp6bdla9SmINJDQQhn1URsGak7WBan3rleiu8QSd1Ng48GNOK4XpWsMUnYdHWRJlbgfb7V1IQVCJgj36RNwTQcmyxvg3eWsZHkt0V4KzaXzIzCH58mbDgwSmGyjpXW/M0P+i0l+5fbmT7pJLF1AvFEMTgIjV2RrF689PaU0agpE6WrSwIE/DqgJExmUKdzL5mK7BKOkcrYPnHl8bM8etMCMpgk/oRlTj1eYU5ihPdxQvBLBV2p5kJkd+jBGAL61PALuWNrH1/eLju/nthxpwGmR/DHZ3OBmlJvl+XWtFgEy4ORpAAJlWXU0YT45fK18FMa6rtlCLeknt8L+Zo4NgQEL7DsfRsPS/SxubDKhbI/4Hk4qXKTYamcdeAnyBq0nHJ5ysZ4hNjkE5Sv+azzVrBwOKEAQWr0fq4IrHHoWhay69bQb85ECQ==;5:oqoLpmTz142+tlvM4wFI7WgkvBBvMYMbPaVPmW+HDj7/7pIBcZ33BOIlwmmo0loPxgpA7Nqqmjr/w+YRFz5zIb7wov+EilxKgklwL4kO03FtIU6jbKl9bIJldYWZ7iBftATRc/kjYHTQ9mPwwISs8oX2ck3gMzw9sKQmNXuOlr4=;7:MoTTMZJeZKIp7L5l0gM5ZeOhbmHtu3Ep2BKR5sjRVWZVYTV2OieHDS+xme5uusm0LvqTdxGbgQn0M+P4gvbgkjdWxjmZMPbIDdobbcPSoRUDEtUPO6UuemAMFld6RbiBgG/BA3On3q/THFoYkeoqlvbPFNLipJ2BZ2b8YEfcSfSB+88+n91MZ4IzvqdtvuN7afY1PdR6cXLqSyTXDCMr1EU1af6GUIAPYLkMOc/nsM/ApNZU2EgzlIsB6uhOCBOZ"} {"x-ms-exchange-antispam-srfa-diagnostics" "SOS;"} {"x-ms-office365-filtering-correlation-id" "038ef2a6-bef8-4330-55b7-08d62d0f7342"} {"x-microsoft-antispam" "BCL:0;PCL:0;RULEID:(7020095)(4652040)(7021145)(8989299)(4534185)(7022145)(4603075)(4627221)(201702281549075)(8990200)(7048125)(7024125)(7027125)(7023125)(5600074)(711020)(2017052603328)(7153060)(7193020);SRVR:AM6PR10MB2424;"} {"x-ms-traffictypediagnostic" "AM6PR10MB2424:"} {"x-microsoft-antispam-prvs" "<AM6PR10MB24244D8B2B57A99861559E5FFEE60@AM6PR10MB2424.EURPRD10.PROD.OUTLOOK.COM>"} {"x-exchange-antispam-report-test" "UriScan:(140570224273261)(268895828855973)(21748063052155)(28532068793085)(190501279198761)(227612066756510);"} {"x-ms-exchange-senderadcheck" "1"} {"x-exchange-antispam-report-cfa-test" "BCL:0;PCL:0;RULEID:(6040522)(2401047)(5005006)(8121501046)(3231355)(944501410)(52105095)(10201501046)(93006095)(93001095)(3002001)(149066)(150057)(6041310)(2016111802025)(20161123558120)(20161123562045)(20161123564045)(20161123560045)(6043046)(201708071742011)(7699051);SRVR:AM6PR10MB2424;BCL:0;PCL:0;RULEID:;SRVR:AM6PR10MB2424;"} {"x-forefront-prvs" "081904387B"} {"x-forefront-antispam-report" "SFV:NSPM;SFS:(10019020)(376002)(366004)(136003)(346002)(396003)(39830400003)(189003)(199004)(2351001)(7736002)(316002)(81156014)(81166006)(2900100001)(5630700001)(71190400001)(3480700004)(39060400002)(71200400001)(7116003)(102836004)(966005)(55016002)(8936002)(6306002)(54896002)(6436002)(236005)(97736004)(2906002)(106356001)(9686003)(6506007)(6116002)(8676002)(5640700003)(1361003)(790700001)(256004)(3846002)(105586002)(74316002)(186003)(7696005)(66066001)(53936002)(68736007)(86362001)(26005)(5250100002)(606006)(476003)(486006)(508600001)(2501003)(25786009)(5660300001)(6916009)(14454004)(33656002)(221733001)(99286004)(217283001)(220243001);DIR:OUT;SFP:1102;SCL:1;SRVR:AM6PR10MB2424;H:AM6PR10MB2328.EURPRD10.PROD.OUTLOOK.COM;FPR:;SPF:None;LANG:en;PTR:InfoNoRecords;MX:1;A:1;"} {"received-spf" "None (protection.outlook.com: ignorabilis.com does not designate\r\n permitted sender hosts)"} {"x-microsoft-antispam-message-info" "pKtMO4/nXuk5dZdFRD+xGz2Be50tZLMC2pfIQk2x5rO+WrKN1x0waXMsSEQmetPrAjg2NX2LaGpdELpySca03gnHHlc94Ie+BjSGU8+GCxTfVWBalhNIrELfcKvm1auFoVT1pMKyw61nyk6B6v8tUtYC+urf0pXOTgxqFrmN/kHu2vDTgQcBzkBKrWtz1DSSH0pwN/sNSZM3dPcvf6PF1TQ0qWtJneqLC8GgQFOQA3Xc2dOxldzjq+Etk+SWigjuj48qVaFs/HTjxPK8wavYPXokh5eXbJeKTXBL4W0IIp/uYoh9lgHQlnVDpR/b9dXSiiVCalPEymD43BQh/6z05MOZ9o8/hN8zC2Eo7NBatIo="} {"spamdiagnosticoutput" "1:99"} {"spamdiagnosticmetadata" "NSPM"} {"Content-Type" "multipart/alternative;\r\n boundary=\"_000_AM6PR10MB2328F1401FAC7F1FA9834E95FEE60AM6PR10MB2328EURP_\""} {"MIME-Version" "1.0"} {"X-OriginatorOrg" "ignorabilis.com"} {"X-MS-Exchange-CrossTenant-Network-Message-Id" "038ef2a6-bef8-4330-55b7-08d62d0f7342"} {"X-MS-Exchange-CrossTenant-originalarrivaltime" "08 Oct 2018 11:16:10.0389 (UTC)"} {"X-MS-Exchange-CrossTenant-fromentityheader" "Hosted"} {"X-MS-Exchange-CrossTenant-id" "349597f0-bb28-43d1-887b-5c4c01390b0f"} {"X-MS-Exchange-Transport-CrossTenantHeadersStamped" "AM6PR10MB2424"}],
                   :date-sent    #inst "2018-10-08T11:16:10.000-00:00", :date-received #inst "2018-10-08T11:16:12.000-00:00",
                   :from         ({:address "irina.yaroslavova@ignorabilis.com", :name "Irina Stefanova"}),
                   :id           "<AM6PR10MB2328F1401FAC7F1FA9834E95FEE60@AM6PR10MB2328.EURPRD10.PROD.OUTLOOK.COM>",
                   :sender       {:address "irina.yaroslavova@ignorabilis.com", :name "Irina Stefanova"},
                   :content-type "multipart/ALTERNATIVE; \r\n\tboundary*0=_000_AM6PR10MB2328F1401FAC7F1FA9834E95FEE60AM6PR10MB2328EURP; \r\n\tboundary*1=_",
                   :multipart?   true,
                   :body         ({:content-type "TEXT/PLAIN; charset=us-ascii",
                                   :body         "https://www.nytimes.com/2018/10/08/us/fema-disaster-recovery-climate-change.html?action=click&module=Top%20Stories&pgtype=Homepage tag1 tag2\r\n\r\nhttps://www.nytimes.com/2018/10/08/us/fema-disaster-recovery-climate-change.html?action=click&module=Top%20Stories&pgtype=Homepage\r\nshould err\r\n\r\nIrina Yaroslavova Stefanova\r\nIgnorabilis Op. Ltd.\r\n\r\n+359886669686\r\nirina.yaroslavova@ignorabilis.com\r\n\r\n"} {:content-type "TEXT/HTML; charset=us-ascii", :body "<html xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:o=\"urn:schemas-microsoft-com:office:office\" xmlns:w=\"urn:schemas-microsoft-com:office:word\" xmlns:m=\"http://schemas.microsoft.com/office/2004/12/omml\" xmlns=\"http://www.w3.org/TR/REC-html40\">\r\n<head>\r\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=us-ascii\">\r\n<meta name=\"Generator\" content=\"Microsoft Word 15 (filtered medium)\">\r\n<style><!--\r\n/* Font Definitions */\r\n@font-face\r\n\t{font-family:\"Cambria Math\";\r\n\tpanose-1:2 4 5 3 5 4 6 3 2 4;}\r\n@font-face\r\n\t{font-family:Calibri;\r\n\tpanose-1:2 15 5 2 2 2 4 3 2 4;}\r\n/* Style Definitions */\r\np.MsoNormal, li.MsoNormal, div.MsoNormal\r\n\t{margin:0in;\r\n\tmargin-bottom:.0001pt;\r\n\tfont-size:11.0pt;\r\n\tfont-family:\"Calibri\",sans-serif;\r\n\tmso-fareast-language:EN-US;}\r\na:link, span.MsoHyperlink\r\n\t{mso-style-priority:99;\r\n\tcolor:#0563C1;\r\n\ttext-decoration:underline;}\r\na:visited, span.MsoHyperlinkFollowed\r\n\t{mso-style-priority:99;\r\n\tcolor:#954F72;\r\n\ttext-decoration:underline;}\r\nspan.EmailStyle17\r\n\t{mso-style-type:personal-compose;\r\n\tfont-family:\"Calibri\",sans-serif;}\r\n.MsoChpDefault\r\n\t{mso-style-type:export-only;\r\n\tfont-family:\"Calibri\",sans-serif;\r\n\tmso-fareast-language:EN-US;}\r\n@page WordSection1\r\n\t{size:8.5in 11.0in;\r\n\tmargin:70.85pt 70.85pt 70.85pt 70.85pt;}\r\ndiv.WordSection1\r\n\t{page:WordSection1;}\r\n--></style><!--[if gte mso 9]><xml>\r\n<o:shapedefaults v:ext=\"edit\" spidmax=\"1026\" />\r\n</xml><![endif]--><!--[if gte mso 9]><xml>\r\n<o:shapelayout v:ext=\"edit\">\r\n<o:idmap v:ext=\"edit\" data=\"1\" />\r\n</o:shapelayout></xml><![endif]-->\r\n</head>\r\n<body lang=\"BG\" link=\"#0563C1\" vlink=\"#954F72\">\r\n<div class=\"WordSection1\">\r\n<p style=\"margin:0in;margin-bottom:.0001pt\"><span lang=\"EN-US\"><a href=\"https://www.nytimes.com/2018/10/08/us/fema-disaster-recovery-climate-change.html?action=click&amp;module=Top%20Stories&amp;pgtype=Homepage\"><span style=\"font-size:12.0pt;color:#0563C1\">https://www.nytimes.com/2018/10/08/us/fema-disaster-recovery-climate-change.html?action=click&amp;module=Top%20Stories&amp;pgtype=Homepage</span></a></span><span lang=\"EN-US\" style=\"font-size:12.0pt;color:black\">\r\n tag1 tag2</span><o:p></o:p></p>\r\n<p style=\"margin:0in;margin-bottom:.0001pt\"><span lang=\"EN-US\"><a href=\"https://www.nytimes.com/2018/10/08/us/fema-disaster-recovery-climate-change.html?action=click&amp;module=Top%20Stories&amp;pgtype=Homepage\"><span style=\"font-size:12.0pt;color:#0563C1\">https://www.nytimes.com/2018/10/08/us/fema-disaster-recovery-climate-change.html?action=click&amp;module=Top%20Stories&amp;pgtype=Homepage</span></a></span><o:p></o:p></p>\r\n<p class=\"MsoNormal\"><span lang=\"EN-US\" style=\"font-size:12.0pt;color:black\">should err</span><o:p></o:p></p>\r\n<p class=\"MsoNormal\"><o:p>&nbsp;</o:p></p>\r\n<p class=\"MsoNormal\"><b><span lang=\"EN-US\" style=\"font-size:10.0pt;mso-fareast-language:BG\">Irina Yaroslavova Stefanova<o:p></o:p></span></b></p>\r\n<p class=\"MsoNormal\"><span lang=\"EN-US\" style=\"font-size:10.0pt;color:#2F5496;mso-fareast-language:BG\">Ignorabilis Op. Ltd.<o:p></o:p></span></p>\r\n<p class=\"MsoNormal\"><span lang=\"EN-US\" style=\"font-size:10.0pt;color:#2F5496;mso-fareast-language:BG\"><o:p>&nbsp;</o:p></span></p>\r\n<p class=\"MsoNormal\"><span lang=\"EN-US\" style=\"font-size:10.0pt;color:#767171;mso-fareast-language:BG\">&#43;359886669686<o:p></o:p></span></p>\r\n<p class=\"MsoNormal\"><span lang=\"EN-US\" style=\"font-size:10.0pt;color:#767171;mso-fareast-language:BG\">irina.yaroslavova@ignorabilis.com<o:p></o:p></span></p>\r\n<p class=\"MsoNormal\"><o:p>&nbsp;</o:p></p>\r\n</div>\r\n</body>\r\n</html>\r\n"}),
                   :subject      "test", :to ({:address "owsy.test@gmail.com", :name "owsy.test@gmail.com"})})

(defn url-or-nil [url?]
  (try
    (URL. url?)
    (catch URISyntaxException e
      )
    (catch Throwable e
      )))

(defn valid-entry? [entry]
  (-> entry
      first
      url-or-nil))

(defn parse-body [mail-body]
  (let [lines   (string/split-lines mail-body)
        entries (mapv #(string/split % #"\s+") lines)
        entries (filterv valid-entry? entries)]
    entries))

(defn parse-mail [mail]
  (let [{{user :address} :sender
         :keys           [body]} mail
        mail-body (-> body first :body)
        entries   (parse-body mail-body)]
    [user entries]))
